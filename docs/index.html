---

title: Pipetography

keywords: fastai
sidebar: home_sidebar

summary: "Nipype and mrtrix3 based pre-/post- processing pipeline for brain diffusion-MRI and generation of structural connectomes of the brain."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This file will become your README and also the index of your documentation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install pipetography</code></p>
<p>Since <code>pipetography</code> is a <code>Nipype</code> wrapper around <code>mrtrix3</code>, <code>ANTs</code>, and <code>FSL</code>, you have to follow their installation instructions:</p>
<ul>
<li><p><a href="https://mrtrix.readthedocs.io/en/latest/installation/before_install.html">mrtrix3</a></p>
</li>
<li><p><a href="https://github.com/ANTsX/ANTs/wiki/Compiling-ANTs-on-Linux-and-Mac-OS">ANTs</a></p>
</li>
<li><p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FslInstallation">FSL</a></p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Use-as-connected-Nipype-nodes-for-DWI-preprocessing">Use as connected Nipype nodes for DWI preprocessing<a class="anchor-link" href="#Use-as-connected-Nipype-nodes-for-DWI-preprocessing">&#182;</a></h4><p>We will wrap all of our tasks in <code>Nipype</code>'s <code>Nodes</code></p>
<p>Nipype wraps the tasks into Nodes and connects them into an automated workflow that can run parallel tasks, the preprocessing workflow includes several functions, some of which require user inputs. We will go over them here, first we need to provide where our subject files are, we recommend using BIDS format subject directories, from which we can create a <code>layout</code> with <code>PyBIDS</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="n">sub_list</span> <span class="o">=</span> <span class="n">get_subs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="c1"># this gets all subjects in BIDS directory. For each subject, we need to iterate over all available sessions.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sub_list</span><span class="p">)</span>
<span class="c1"># we only have 1 subject for the sample dataset</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating layout of data directory, might take a while if there are a lot of subjects
[&#39;11048&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Subject-data-I/O:">Subject data I/O:<a class="anchor-link" href="#Subject-data-I/O:">&#182;</a></h4><p>We need to use <code>Nipype</code>'s <code>IdentityInterface</code> and <code>SelectFiles</code> functionalities to iterable over subjects. The <code>iterables</code> function in <code>Nipype</code> can expand your workflow to each subject:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nipype</span> <span class="kn">import</span> <span class="n">IdentityInterface</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span>

<span class="c1"># IdentityInterface allows us to work with strings as input parameters</span>
<span class="n">sub_source</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;infosource&#39;</span><span class="p">)</span>
<span class="n">sub_source</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">sub_list</span><span class="p">)]</span>

<span class="c1"># Node for selecting files, we need to create a template to tell it what the file paths look like:</span>
<span class="n">dwi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-*&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">_ses-*_dwi.nii.gz&#39;</span><span class="p">)</span>
<span class="n">bv_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">_ses-1_dwi.bv*&#39;</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dwi&#39;</span><span class="p">:</span> <span class="n">dwi_file</span><span class="p">,</span> <span class="s1">&#39;bvs&#39;</span><span class="p">:</span> <span class="n">bv_files</span><span class="p">}</span>
<span class="c1"># then create Node:</span>
<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;selectfiles&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We need to also build <code>Nodes</code> that grabs <code>bvec</code> and <code>bval</code> files for our inputs:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nipype</span> <span class="kn">import</span> <span class="n">Function</span>

<span class="n">bvspath_getter</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_List&#39;</span><span class="p">],</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_path&#39;</span><span class="p">],</span> <span class="n">function</span> <span class="o">=</span> <span class="n">bfiles2tuple</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;BV_Getter&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lastly, we need to create an input <code>Node</code> for atlases! We use atlases to identify regions of interests (ROIs) after co-registering them onto our DWI images. For this example, we will use the Desikan-Killiany and Brainnectome atlases:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atlas_dir</span> <span class="o">=</span> <span class="s1">&#39;atlases&#39;</span>

<span class="n">atlas_template</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;atlas&#39;</span><span class="p">:</span> <span class="n">atlas_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{file_name}</span><span class="s1">&#39;</span><span class="p">}</span>
<span class="n">atlas_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BN_Atlas_246_2mm.nii&#39;</span><span class="p">,</span><span class="s1">&#39;DK_atlas86_1mm.nii&#39;</span><span class="p">]</span> <span class="c1"># list of atlases you want to use</span>
<span class="n">atlas_file</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">atlas_template</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;select_atlas&#39;</span><span class="p">)</span>
<span class="n">atlas_file</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">atlas_dir</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Preprocessing-of-DWI:">Preprocessing of DWI:<a class="anchor-link" href="#Preprocessing-of-DWI:">&#182;</a></h4><p>Now we can finally start our first step: denoise!</p>
<p>We will do this with <code>mrtrix3</code>'s <a href="/pipetography/pipetography#dwidenoise"><code>dwidenoise</code></a> function after wrapping it in a <code>MapNode</code>, these are Nodes that can handle several inputs/outputs with iterables:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">denoise</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">dwidenoise</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;denoise&quot;</span><span class="p">,</span> <span class="n">iterfield</span> <span class="o">=</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">denoise</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s2">&quot;denoised.nii.gz&quot;</span>
<span class="n">denoise</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="s2">&quot;noise.nii.gz&quot;</span>
<span class="n">denoise</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="s2">&quot;-force&quot;</span> <span class="c1"># in case there&#39;s previous outputs, we want to overwrite</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
</div>
 

