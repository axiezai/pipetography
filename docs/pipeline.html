---

title: Module pipeline

keywords: fastai
sidebar: home_sidebar

summary: "Here we have the Nodes wrapping around our core functions, which can be added to a Nipype workflow to process your input images. These definitions here are our custom functions and Nipype Nodes knotted together, which creates a working pipeline."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_pipeline.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>200306-15:25:38,85 nipype.utils INFO:
	 No new version available.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <a href="/pipetography/pipeline"><code>pipeline</code></a> class that puts everything together.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="pipeline" class="doc_header"><code>class</code> <code>pipeline</code><a href="https://github.com/axiezai/pipetography/tree/master/pipetography/pipeline.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>pipeline</code>(<strong><code>BIDS_dir</code></strong>=<em><code>'data'</code></em>)</p>
</blockquote>
<p>A class containing functionalities and inputs to the image processing pipeline
Input:
    BIDS_dir (str): Valid BIDS directory with DWI modality
Attributes:
    data_dir (str)
    sub_list (List)
    layout (PyBIDS Layout)
    bfiles_fsl (tuple)</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Example:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#create pipeline:</span>
<span class="n">preproc_dwi</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating layout of data directory, might take a while if there are a lot of subjects
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Check if our environment is properly set-up:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">check_environment</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>FSLOUTPUTTYPE is valid
FSLDIR is valid
ANTS is valid
mrtrix3 is valid
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="c1">#set output destination:</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">set_datasink</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Take a look at what's in the <a href="/pipetography/pipeline"><code>pipeline</code></a>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preproc_dwi</span><span class="o">.</span><span class="vm">__dict__</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;data_dir&#39;: &#39;data&#39;,
 &#39;sub_list&#39;: [&#39;11048&#39;],
 &#39;layout&#39;: BIDS Layout: ...ers/xxie/lab/pipetography/data | Subjects: 1 | Sessions: 1 | Runs: 0,
 &#39;dwi_file&#39;: &#39;sub-{subject_id}/ses-*/dwi/sub-{subject_id}_ses-*_dwi.nii.gz&#39;,
 &#39;b_files&#39;: &#39;sub-{subject_id}/ses-1/dwi/sub-{subject_id}_ses-1_dwi.bv*&#39;,
 &#39;sub_template&#39;: {&#39;dwi&#39;: &#39;sub-{subject_id}/ses-*/dwi/sub-{subject_id}_ses-*_dwi.nii.gz&#39;,
  &#39;b_files&#39;: &#39;sub-{subject_id}/ses-1/dwi/sub-{subject_id}_ses-1_dwi.bv*&#39;},
 &#39;sub_source&#39;: data_source,
 &#39;select_files&#39;: select_files,
 &#39;bfiles_input&#39;: select_bfiles,
 &#39;denoise&#39;: denoise,
 &#39;ringing&#39;: ringing_removal,
 &#39;ants_bfc&#39;: ants_bias_correct,
 &#39;mrt_preproc&#39;: mrtrix3_preproc,
 &#39;atlas_dir&#39;: None,
 &#39;atlas_names&#39;: None,
 &#39;atlas_source&#39;: None,
 &#39;select_atlas&#39;: None,
 &#39;b0extract&#39;: dwiextract,
 &#39;b0mean&#39;: mrmath,
 &#39;fsl_bet&#39;: brain_extraction,
 &#39;linear_coreg&#39;: linear_registration,
 &#39;nonlinear_coreg&#39;: nonlinear_registration,
 &#39;datasink&#39;: datasink,
 &#39;workflow&#39;: None}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can set up preprocessing pipeline with default parameters:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="c1">#usage</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">default_setup</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;data_dir&#39;: &#39;data&#39;, &#39;sub_list&#39;: [&#39;11048&#39;], &#39;layout&#39;: BIDS Layout: ...ers/xxie/lab/pipetography/data | Subjects: 1 | Sessions: 1 | Runs: 0, &#39;dwi_file&#39;: &#39;sub-{subject_id}/ses-*/dwi/sub-{subject_id}_ses-*_dwi.nii.gz&#39;, &#39;b_files&#39;: &#39;sub-{subject_id}/ses-1/dwi/sub-{subject_id}_ses-1_dwi.bv*&#39;, &#39;sub_template&#39;: {&#39;dwi&#39;: &#39;sub-{subject_id}/ses-*/dwi/sub-{subject_id}_ses-*_dwi.nii.gz&#39;, &#39;b_files&#39;: &#39;sub-{subject_id}/ses-1/dwi/sub-{subject_id}_ses-1_dwi.bv*&#39;}, &#39;sub_source&#39;: default_workflow.data_source, &#39;select_files&#39;: default_workflow.select_files, &#39;bfiles_input&#39;: default_workflow.select_bfiles, &#39;denoise&#39;: default_workflow.denoise, &#39;ringing&#39;: default_workflow.ringing_removal, &#39;ants_bfc&#39;: default_workflow.ants_bias_correct, &#39;mrt_preproc&#39;: default_workflow.mrtrix3_preproc, &#39;atlas_dir&#39;: &#34;&#39;/Users/xxie/lab/atlases&#39;&#34;, &#39;atlas_names&#39;: [&#39;[&#39;, &#34;&#39;&#34;, &#39;B&#39;, &#39;N&#39;, &#39;_&#39;, &#39;A&#39;, &#39;t&#39;, &#39;l&#39;, &#39;a&#39;, &#39;s&#39;, &#39;_&#39;, &#39;2&#39;, &#39;4&#39;, &#39;6&#39;, &#39;_&#39;, &#39;2&#39;, &#39;m&#39;, &#39;m&#39;, &#39;.&#39;, &#39;n&#39;, &#39;i&#39;, &#39;i&#39;, &#34;&#39;&#34;, &#39;,&#39;, &#34;&#39;&#34;, &#39;D&#39;, &#39;K&#39;, &#39;_&#39;, &#39;a&#39;, &#39;t&#39;, &#39;l&#39;, &#39;a&#39;, &#39;s&#39;, &#39;8&#39;, &#39;6&#39;, &#39;_&#39;, &#39;1&#39;, &#39;m&#39;, &#39;m&#39;, &#39;.&#39;, &#39;n&#39;, &#39;i&#39;, &#39;i&#39;, &#34;&#39;&#34;, &#39;]&#39;], &#39;atlas_source&#39;: default_workflow.atlas_source, &#39;select_atlas&#39;: default_workflow.select_atlases, &#39;b0extract&#39;: default_workflow.dwiextract, &#39;b0mean&#39;: default_workflow.mrmath, &#39;fsl_bet&#39;: default_workflow.brain_extraction, &#39;linear_coreg&#39;: default_workflow.linear_registration, &#39;nonlinear_coreg&#39;: default_workflow.nonlinear_registration, &#39;datasink&#39;: default_workflow.datasink, &#39;workflow&#39;: default_workflow}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>OR we can fill this in one by one:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, let's tell the pipeline where we have atlas volumes and which ones to use:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">atlas_inputs</span><span class="p">(</span><span class="n">atlas_dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/xxie/lab/atlases&#39;</span><span class="p">,</span> <span class="n">atlas_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BN_Atlas_246_2mm.nii&#39;</span><span class="p">,</span><span class="s1">&#39;DK_atlas86_1mm.nii&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we give inputs to the <code>denoise</code> Node:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">denoise_inputs</span><span class="p">(</span><span class="n">force</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1"># we kept everything else default, like output names and number of threads.</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Gibbs ringing removal:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">DeGibbs_inputs</span><span class="p">()</span> <span class="c1"># keep it default</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output file name is &#39;</span> <span class="o">+</span> <span class="n">preproc_dwi</span><span class="o">.</span><span class="n">ringing</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>ANTs Bias Field Correction:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">ants_bfc_inputs</span><span class="p">()</span> <span class="c1"># keep it default:</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">ants_bfc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">print_traits</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>in_file</code> is undefined because we will feed it this information once we connect our individual functions.</p>
<p>Next let's set up eddy current/motion correction, we need to tell the pipeline the phase encoding settings and inputs to eddy algorithm:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">mrt_preproc_inputs</span><span class="p">(</span>
    <span class="n">rpe_options</span><span class="o">=</span><span class="s2">&quot;-rpe_none&quot;</span><span class="p">,</span>
    <span class="n">pe_dir</span><span class="o">=</span><span class="s2">&quot;j-&quot;</span><span class="p">,</span>
    <span class="n">eddy_options</span><span class="o">=</span><span class="s1">&#39;&quot;--slm=linear --verbose&quot;&#39;</span><span class="p">,</span>
    <span class="n">nthreads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">mrt_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">print_traits</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>grad_fsl</code> and <code>in_file</code> will be input via connected workflow later</p>
<p>Next, we set-up brain extraction from B0 volumes:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="c1"># Extract b0 volumes:</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">b0extract_inputs</span><span class="p">()</span> <span class="c1">#default</span>
<span class="c1"># Create average B0 volume:</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">b0mean_inputs</span><span class="p">()</span> <span class="c1">#default</span>
<span class="c1"># Extract brain from B0 average volume:</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">bet_inputs</span><span class="p">()</span> <span class="c1">#defaults again, using FSL&#39;s BET</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>ANTs registration set up:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">linear_coreg_inputs</span><span class="p">()</span> <span class="c1">#defaults</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">nonlinear_coreg_inputs</span><span class="p">()</span> <span class="c1">#defaults</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">nonlinear_coreg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">print_traits</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All the default settings may not be optimal for your dataset, run the processing for a test image and see the intermediate results and then tweak the available inputs to improve the output image quality.</p>
<p>Now that our pre-processing Nodes are properly setup, we can connect and create a workflow:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">connect_nodes</span><span class="p">(</span><span class="n">wf_name</span> <span class="o">=</span> <span class="s1">&#39;pipetography_workflow&#39;</span><span class="p">)</span>
<span class="n">preproc_dwi</span><span class="o">.</span><span class="n">draw_pipeline</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's take a look at the final workflow we created:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#example</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="s1">&#39;data/derivatives/test_run/pipetography_detailed.png&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
</div>
 

